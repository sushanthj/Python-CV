<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>OpenCV | Python Notes</title><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="OpenCV" /><meta property="og:locale" content="en_US" /><meta name="description" content="Python Notes" /><meta property="og:description" content="Python Notes" /><link rel="canonical" href="/OpenCV/" /><meta property="og:url" content="/OpenCV/" /><meta property="og:site_name" content="Python Notes" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="OpenCV" /> <script type="application/ld+json"> {"@type":"WebPage","url":"/OpenCV/","headline":"OpenCV","description":"Python Notes","@context":"https://schema.org"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"> Python Notes </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="/intro/" class="nav-list-link">Intro</a><li class="nav-list-item"><a href="/Lists%20and%20Strings/" class="nav-list-link">Lists and Strings</a><li class="nav-list-item"><a href="/Dictionaries/" class="nav-list-link">Dictionaries</a><li class="nav-list-item"><a href="/Power%20of%20Introspection/" class="nav-list-link">Functions and Modules</a><li class="nav-list-item"><a href="/Objects/" class="nav-list-link">Objects</a><li class="nav-list-item"><a href="/Exceptions+File_Handlers/" class="nav-list-link">Exceptions and File Handling</a><li class="nav-list-item"><a href="/Regex/" class="nav-list-link">RegEx</a><li class="nav-list-item"><a href="/File_Ops_and_Parsing/" class="nav-list-link">File Ops and Parsing</a><li class="nav-list-item"><a href="/numpy/" class="nav-list-link">Numpy</a><li class="nav-list-item"><a href="/CV%20Concepts/" class="nav-list-link">CV Edge Detection and Filters</a><li class="nav-list-item active"><a href="/OpenCV/" class="nav-list-link active">OpenCV</a><li class="nav-list-item"><a href="/Multi-Proc,%20JSON,%20usr_inp/" class="nav-list-link">Multi-Processing, JSONS, and User-Inputs</a><li class="nav-list-item"><a href="/git_concepts" class="nav-list-link">Git Concepts</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Python Notes" aria-label="Search Python Notes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/sushanthj" class="site-button" > Sushanth's GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><div id="main-content" class="main-content" role="main"> <details open=""> <summary class="text-delta"> Table of contents </summary><ol id="markdown-toc"><li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you Begin</a><ol><li><a href="#note-the-axes-convention-for-numpy-and-opencv-are-different-in-some-instances" id="markdown-toc-note-the-axes-convention-for-numpy-and-opencv-are-different-in-some-instances">Note: The axes convention for numpy and opencv are different in some instances</a></ol><li><a href="#basic-image-operations" id="markdown-toc-basic-image-operations">Basic Image Operations</a><ol><li><a href="#read-image-overlap-image-show-image-and-create-new-image" id="markdown-toc-read-image-overlap-image-show-image-and-create-new-image">Read Image, Overlap Image, Show Image and Create New Image</a><li><a href="#split-rgb-channels" id="markdown-toc-split-rgb-channels">Split RGB Channels</a><li><a href="#extracting-region-of-interest-roi" id="markdown-toc-extracting-region-of-interest-roi">Extracting Region of Interest (ROI)</a><li><a href="#grayscale-and-thresholding" id="markdown-toc-grayscale-and-thresholding">Grayscale and Thresholding</a><li><a href="#adaptive-thresholding--also-nice-way-to-print-multiple-images" id="markdown-toc-adaptive-thresholding--also-nice-way-to-print-multiple-images">Adaptive Thresholding ( Also nice way to print multiple images)</a><li><a href="#creating-custom-window-sizes-and-putting-text-on-images" id="markdown-toc-creating-custom-window-sizes-and-putting-text-on-images">Creating custom window sizes and putting text on images</a><li><a href="#bitwise-operations" id="markdown-toc-bitwise-operations">Bitwise operations</a><li><a href="#masking-an-image" id="markdown-toc-masking-an-image">Masking an Image</a><li><a href="#resizing-an-image" id="markdown-toc-resizing-an-image">Resizing an Image</a><li><a href="#translating-and-rotating-an-image" id="markdown-toc-translating-and-rotating-an-image">Translating and Rotating an Image</a><ol><li><a href="#translation" id="markdown-toc-translation">Translation</a><li><a href="#rotation" id="markdown-toc-rotation">Rotation</a></ol><li><a href="#affine-transformation-vs-perspective-transformation" id="markdown-toc-affine-transformation-vs-perspective-transformation">Affine Transformation vs Perspective Transformation</a></ol><li><a href="#kernel-operations" id="markdown-toc-kernel-operations">Kernel Operations</a><ol><li><a href="#averaging-filter" id="markdown-toc-averaging-filter">Averaging filter</a><li><a href="#gaussian-blur" id="markdown-toc-gaussian-blur">Gaussian Blur</a><li><a href="#perspective-transforms-and-homography" id="markdown-toc-perspective-transforms-and-homography">Perspective Transforms and Homography</a><ol><li><a href="#points-to-note-on-perspective-transform-opencv-functions" id="markdown-toc-points-to-note-on-perspective-transform-opencv-functions">Points to Note on perspective transform opencv functions:</a></ol></ol><li><a href="#buiding-and-using-opencv-with-cuda" id="markdown-toc-buiding-and-using-opencv-with-cuda">Buiding and Using opencv with CUDA</a><ol><li><a href="#the-process-for-building-opencv-with-cuda" id="markdown-toc-the-process-for-building-opencv-with-cuda">The process for building opencv with CUDA</a><li><a href="#example-of-cv2cuda" id="markdown-toc-example-of-cv2cuda">Example of cv2.cuda</a></ol></ol></details><h1 class="fs-9" id="before-you-begin"> <a href="#before-you-begin" class="anchor-heading" aria-labelledby="before-you-begin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Before you Begin</h1><p><a href="https://docs.opencv.org/master/d6/d00/tutorial_py_root.html" class="btn fs-5 mb-4 mb-md-0">Reference</a></p><p>Many numpy functions will still be used alongside OpenCV as it augments the capabilities of OpenCV</p><h2 id="note-the-axes-convention-for-numpy-and-opencv-are-different-in-some-instances"> <a href="#note-the-axes-convention-for-numpy-and-opencv-are-different-in-some-instances" class="anchor-heading" aria-labelledby="note-the-axes-convention-for-numpy-and-opencv-are-different-in-some-instances"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Note: The axes convention for numpy and opencv are different in some instances</h2><p>For basic image ops:</p><ul><li>numpy has [width, height, depth] as the three axes<li>opencv has [height, width, depth] as the three axes</ul><p>However, for operations such as cv2.rectangle, i.e.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">start_point</span><span class="p">,</span> <span class="n">end_point</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span>
<span class="c1"># the start point is (x,y) i.e. same as numpy
</span></code></pre></div></div><p>But, if we’re extracting an ROI (see section below), then we do: <code class="language-plaintext highlighter-rouge">ball = img[280:340, 330:390]</code></p><p>here the 280:340 = height and 330:390 = width</p><h1 id="basic-image-operations"> <a href="#basic-image-operations" class="anchor-heading" aria-labelledby="basic-image-operations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Basic Image Operations</h1><h2 id="read-image-overlap-image-show-image-and-create-new-image"> <a href="#read-image-overlap-image-show-image-and-create-new-image" class="anchor-heading" aria-labelledby="read-image-overlap-image-show-image-and-create-new-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Read Image, Overlap Image, Show Image and Create New Image</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'walk_1.jpg'</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'walk_2.jpg'</span><span class="p">)</span>

<span class="n">img3</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'img3'</span><span class="p">,</span> <span class="n">img3</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>

<span class="n">cv2</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s">"opencv-threshold-example.jpg"</span><span class="p">,</span> <span class="n">img3</span><span class="p">)</span>
</code></pre></div></div><h2 id="split-rgb-channels"> <a href="#split-rgb-channels" class="anchor-heading" aria-labelledby="split-rgb-channels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Split RGB Channels</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">merge</span><span class="p">((</span><span class="n">b</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>

<span class="c1">#or we can also use numpy and do faster/more efficiently than cv.split
</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#to set all red pixels to zero
</span>
<span class="n">img</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div><h2 id="extracting-region-of-interest-roi"> <a href="#extracting-region-of-interest-roi" class="anchor-heading" aria-labelledby="extracting-region-of-interest-roi"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Extracting Region of Interest (ROI)</h2><p>The axes of an image by default is saved as:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">()</span>
</code></pre></div></div><p>In the above height, width, and depth:</p><ul><li>depth is saved as it normally would be<li>height is defined as top of image is zero and bottom of image is max height / (opposite of the normal y-axis)<li>width is defined normally, from left to right like ‘x-axis’</ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ball</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">280</span><span class="p">:</span><span class="mi">340</span><span class="p">,</span> <span class="mi">330</span><span class="p">:</span><span class="mi">390</span><span class="p">]</span>
<span class="n">img</span><span class="p">[</span><span class="mi">273</span><span class="p">:</span><span class="mi">333</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span><span class="mi">160</span><span class="p">]</span> <span class="o">=</span> <span class="n">ball</span>
</code></pre></div></div><h2 id="grayscale-and-thresholding"> <a href="#grayscale-and-thresholding" class="anchor-heading" aria-labelledby="grayscale-and-thresholding"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grayscale and Thresholding</h2><p>There are two common color spaces used in OpenCV\</p><ul><li>cv.COLOR_BGR2GRAY<li>cv.COLOR_BGR2HSV</ul><p>Thresholding sSyntax is given as<br /> <b>cv.threshold(source, thresholdValue, maxVal, thresholdingTechnique)</b></p><p>Few thresholding techniques are:</p><ul><li><strong>cv.THRESH_BINARY</strong>: If pixel intensity is greater than the set threshold, value set to 255, else set to 0 (black)<li><strong>cv.THRESH_BINARY_INV</strong>: Inverted or Opposite case of cv.THRESH_BINARY<li><strong>cv.THRESH_TRUNC</strong>: If pixel intensity value is greater than threshold, it is truncated to the threshold. The pixel values are set to be the same as the threshold. All other values remain the same<li><strong>cv.THRESH_TOZERO</strong>: Pixel intensity is set to 0, for all the pixels intensity, less than the threshold value<li><strong>cv.THRESH_TOZERO_INV</strong>: Inverted or Opposite case of cv.THRESH_TOZERO</ul><p><strong>The Thresholding will generate two outputs. That’s why we’ll save the output of cv.THRESH in two images</strong></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Make image grayscale before thresholding ALWAYS
</span>
<span class="n">gray_img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="c1"># Or make grayscale during image read itself
</span>
<span class="n">gray_img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">"threshold.png"</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>

<span class="c1"># Apply Threshold
</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">thresh1</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">grau_img</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>

<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'Binary Threshold'</span><span class="p">,</span> <span class="n">thresh1</span><span class="p">)</span>
</code></pre></div></div><h2 id="adaptive-thresholding--also-nice-way-to-print-multiple-images"> <a href="#adaptive-thresholding--also-nice-way-to-print-multiple-images" class="anchor-heading" aria-labelledby="adaptive-thresholding--also-nice-way-to-print-multiple-images"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Adaptive Thresholding ( Also nice way to print multiple images)</h2><p><strong>Syntax : cv2.adaptiveThreshold(src, maxValue, adaptiveMethod, thresholdType, blockSize, C[, dst])</strong></p><ul><li>src – Source 8-bit single-channel image.<li>dst – Destination image of the same size and the same type as src .<li>maxValue – Non-zero value assigned to the pixels for which the condition is satisfied. See the details below.<li>adaptiveMethod – Adaptive thresholding algorithm to use, ADAPTIVE_THRESH_MEAN_C or ADAPTIVE_THRESH_GAUSSIAN_C . See the details below.<li>thresholdType – Thresholding type that must be either THRESH_BINARY or THRESH_BINARY_INV .<li>blockSize – Size of a pixel neighborhood that is used to calculate a threshold value for the pixel: 3, 5, 7, and so on.<li>C – Constant subtracted from the mean or weighted mean (see the details below). Normally, it is positive but may be zero or negative as well.</ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'sudoku.png'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="n">ret</span><span class="p">,</span><span class="n">th1</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">cv</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
<span class="n">th2</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">cv</span><span class="p">.</span><span class="n">ADAPTIVE_THRESH_MEAN_C</span><span class="p">,</span>\
            <span class="n">cv</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">th3</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">adaptiveThreshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">cv</span><span class="p">.</span><span class="n">ADAPTIVE_THRESH_GAUSSIAN_C</span><span class="p">,</span><span class="n">cv</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Original Image'</span><span class="p">,</span> <span class="s">'Global Thresholding (v = 127)'</span><span class="p">,</span>
            <span class="s">'Adaptive Mean Thresholding'</span><span class="p">,</span> <span class="s">'Adaptive Gaussian Thresholding'</span><span class="p">]</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="p">,</span> <span class="n">th1</span><span class="p">,</span> <span class="n">th2</span><span class="p">,</span> <span class="n">th3</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">'gray'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xticks</span><span class="p">([]),</span><span class="n">plt</span><span class="p">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div><hr /><h2 id="creating-custom-window-sizes-and-putting-text-on-images"> <a href="#creating-custom-window-sizes-and-putting-text-on-images" class="anchor-heading" aria-labelledby="creating-custom-window-sizes-and-putting-text-on-images"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating custom window sizes and putting text on images</h2><p>The below code will also take user input and executes custom commands like an if-else statement</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">h1</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
        
        <span class="n">cv2</span><span class="p">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_orig_path</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span> <span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">fontScale</span><span class="p">,</span> <span class="n">fontColor</span><span class="p">,</span> <span class="n">lineType</span><span class="p">)</span> 
        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),(</span><span class="mi">36</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">120</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s">"display_image"</span><span class="p">,</span><span class="n">cv2</span><span class="p">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">resizeWindow</span><span class="p">(</span><span class="s">"display_image"</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"display_image"</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
        <span class="k">if</span> <span class="n">k1</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'q'</span><span class="p">):</span>
            <span class="n">cv2</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span> 
            <span class="k">print</span><span class="p">(</span><span class="s">"&gt; User exit request"</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">k1</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s">'p'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'okay'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="k">pass</span>
</code></pre></div></div><h2 id="bitwise-operations"> <a href="#bitwise-operations" class="anchor-heading" aria-labelledby="bitwise-operations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Bitwise operations</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>

<span class="c1"># Load two images
</span><span class="n">img1</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'messi5.jpg'</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'opencv-logo-white.png'</span><span class="p">)</span>

<span class="c1"># I want to put logo on top-left corner, So I create a ROI
</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">channels</span> <span class="o">=</span> <span class="n">img2</span><span class="p">.</span><span class="n">shape</span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">img1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">cols</span><span class="p">]</span>

<span class="c1"># Now create a mask of logo and create its inverse mask also
</span><span class="n">img2gray</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span><span class="n">cv</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">ret</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img2gray</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
<span class="n">mask_inv</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>


<span class="c1"># Now black-out the area of logo in ROI
</span><span class="n">img1_bg</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span><span class="n">roi</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask_inv</span><span class="p">)</span>


<span class="c1"># Take only region of logo from logo image.
</span><span class="n">img2_fg</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span><span class="n">img2</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span>


<span class="c1"># Put logo in ROI and modify the main image
</span><span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">img1_bg</span><span class="p">,</span><span class="n">img2_fg</span><span class="p">)</span>
<span class="n">img1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">cols</span> <span class="p">]</span> <span class="o">=</span> <span class="n">dst</span>

<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'res'</span><span class="p">,</span><span class="n">img1</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'img1_bg'</span><span class="p">,</span> <span class="n">img1_bg</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'img2_fg'</span><span class="p">,</span><span class="n">img2_fg</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'mask'</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'mask_inv'</span><span class="p">,</span> <span class="n">mask_inv</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div></div><p>The output will be as follows: <img src="/images/opencv1.png" alt="" /></p><h2 id="masking-an-image"> <a href="#masking-an-image" class="anchor-heading" aria-labelledby="masking-an-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Masking an Image</h2><ul><li>Firstly the mask has to be same size as image<li>Secondly, the mask needs a white region where we’ll be performing our bitwise ops</ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># zero mask unwanted regions in the image
</span><span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1328</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s">"uint8"</span><span class="p">)</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">mask</span><span class="p">,(</span><span class="mi">130</span><span class="p">,</span><span class="mi">300</span><span class="p">),(</span><span class="mi">1200</span><span class="p">,</span><span class="mi">1020</span><span class="p">),(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">depth_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">depth_img</span><span class="p">,</span> <span class="n">depth_img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
</code></pre></div></div><h2 id="resizing-an-image"> <a href="#resizing-an-image" class="anchor-heading" aria-labelledby="resizing-an-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resizing an Image</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Default interpolation method is cv.INTER_LINEAR which is faster than cv.INTER_CUBIC
</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'messi5.jpg'</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">fx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
</code></pre></div></div><h2 id="translating-and-rotating-an-image"> <a href="#translating-and-rotating-an-image" class="anchor-heading" aria-labelledby="translating-and-rotating-an-image"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Translating and Rotating an Image</h2><p><strong>Syntax: cv2.warpAffine(src, M, dsize, dst, flags, borderMode, borderValue)</strong></p><p>The parameter M is the transformation matrix and this matrix dictates whether we translate or rotate the image or any of the other several operations</p><ul><li>src: input image<li>dst: output image that has the size dsize and the same type as src.<li>M: transformation matrix.<li>dsize: size of the output image. eg. cv.warpAffine((100,100))<li>flags: combination of interpolation methods (see resize() ) and the optional flag<li>WARP_INVERSE_MAP that means that M is the inverse transformation (dst-&gt;src).<li>borderMode: pixel extrapolation method; when borderMode=BORDER_TRANSPARENT, it means that the pixels in the destination image corresponding to the “outliers” in the source image are not modified by the function.<li>borderValue: value used in case of a constant border; by default, it is 0.</ul><h3 id="translation"> <a href="#translation" class="anchor-heading" aria-labelledby="translation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Translation</h3><p>The below example shows x_translation of 150 pixels and y_translation of 50 pixels</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'messi5.jpg'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">50</span><span class="p">]])</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="n">cols</span><span class="p">,</span><span class="n">rows</span><span class="p">))</span>
<span class="n">cv</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'img'</span><span class="p">,</span><span class="n">dst</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</code></pre></div></div><h3 id="rotation"> <a href="#rotation" class="anchor-heading" aria-labelledby="rotation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Rotation</h3><p>For rotation we manually find the correct rotation matrix using an inbuilt function of OpenCV</p><p><img src="/images/opencv2.png" alt="" /></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'messi5.jpg'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>
<span class="c1"># cols-1 and rows-1 are the coordinate limits.
</span><span class="n">M</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">getRotationMatrix2D</span><span class="p">(((</span><span class="n">cols</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,(</span><span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span><span class="mi">90</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="n">cols</span><span class="p">,</span><span class="n">rows</span><span class="p">))</span>
</code></pre></div></div><h2 id="affine-transformation-vs-perspective-transformation"> <a href="#affine-transformation-vs-perspective-transformation" class="anchor-heading" aria-labelledby="affine-transformation-vs-perspective-transformation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Affine Transformation vs Perspective Transformation</h2><p>In Affine transformation all parallel liles will remain parallel after transformation.</p><p>This also needs 3 points to be mapped from input to output as a reference to build the transformation matrix</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'drawing.png'</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>

<span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">],[</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">],[</span><span class="mi">50</span><span class="p">,</span><span class="mi">200</span><span class="p">]])</span>
<span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">],[</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">],[</span><span class="mi">100</span><span class="p">,</span><span class="mi">250</span><span class="p">]])</span>

<span class="n">M</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">getAffineTransform</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span><span class="n">pts2</span><span class="p">)</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="n">cols</span><span class="p">,</span><span class="n">rows</span><span class="p">))</span>
</code></pre></div></div><p>In Perspective transformation all straight lines will remain straight even after transformation</p><p>This needs 4 point mapping from input to output image to build transformation matrix</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'sudoku.png'</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">shape</span>

<span class="n">pts1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">56</span><span class="p">,</span><span class="mi">65</span><span class="p">],[</span><span class="mi">368</span><span class="p">,</span><span class="mi">52</span><span class="p">],[</span><span class="mi">28</span><span class="p">,</span><span class="mi">387</span><span class="p">],[</span><span class="mi">389</span><span class="p">,</span><span class="mi">390</span><span class="p">]])</span>
<span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">300</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">300</span><span class="p">],[</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">]])</span>

<span class="n">M</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">getPerspectiveTransform</span><span class="p">(</span><span class="n">pts1</span><span class="p">,</span><span class="n">pts2</span><span class="p">)</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">M</span><span class="p">,(</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
</code></pre></div></div><hr /><h1 id="kernel-operations"> <a href="#kernel-operations" class="anchor-heading" aria-labelledby="kernel-operations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Kernel Operations</h1><h2 id="averaging-filter"> <a href="#averaging-filter" class="anchor-heading" aria-labelledby="averaging-filter"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Averaging filter</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'opencv_logo.png'</span><span class="p">)</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kernel</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">),</span><span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Original'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xticks</span><span class="p">([]),</span> <span class="n">plt</span><span class="p">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">),</span><span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Averaging'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xticks</span><span class="p">([]),</span> <span class="n">plt</span><span class="p">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div><h2 id="gaussian-blur"> <a href="#gaussian-blur" class="anchor-heading" aria-labelledby="gaussian-blur"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Gaussian Blur</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'opencv-logo-white.png'</span><span class="p">)</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">img</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> <span class="c1">#Normal averging filter
</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div><h2 id="perspective-transforms-and-homography"> <a href="#perspective-transforms-and-homography" class="anchor-heading" aria-labelledby="perspective-transforms-and-homography"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Perspective Transforms and Homography</h2><p>In homography we can:</p><ol><li>Match the FOV of one camera to another camera (which is slighly offset from the first)<li>Warp an image to remove distorion effects</ol><p>We achieve this by first finding a homography matrix. The basic backend is shown below:</p><p><img src="/images/homography.png" alt="" /></p><p>The basic code to find the homography matrix and to do the actual perspective transform uses three OpenCV functions:</p><ul><li><code class="language-plaintext highlighter-rouge">cv2.findHomography(pts_dst, pts_src)</code><li><code class="language-plaintext highlighter-rouge">cv2.warpPerspective(im_dst, h, (im_src.shape[1],im_src.shape[0]))</code><li><code class="language-plaintext highlighter-rouge">transformed_points = cv2.perspectiveTransform(test_points,h)</code></ul><p>In the above options:</p><p>h = transformation matrix <br /> im_dst = destination image <br /> im_src = source image <br /> pts_dst = keypoints on the destination image <br /> pts_src = keypoints on the source image</p><p><strong>The destination image will be the image which will be transformed to match the source image</strong></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">cgi</span> <span class="kn">import</span> <span class="n">test</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">numpy.lib.npyio</span> <span class="kn">import</span> <span class="n">load</span>

<span class="k">def</span> <span class="nf">compute_transformation</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="s">"/home/sush/TS/misc/test_scripts/"</span><span class="p">):</span>
    <span class="c1"># Read source image.
</span>    <span class="n">im_src</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span>
    <span class="c1"># Four corners of the book in source image
</span>    <span class="c1"># pts_idx = [1,2,3,4,5,6,13,7,8,9,10,11,12]
</span>    <span class="n">pts_src</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">24</span><span class="p">,</span><span class="mi">240</span><span class="p">],[</span><span class="mi">120</span><span class="p">,</span><span class="mi">223</span><span class="p">],[</span><span class="mi">252</span><span class="p">,</span><span class="mi">224</span><span class="p">],[</span><span class="mi">413</span><span class="p">,</span><span class="mi">221</span><span class="p">],[</span><span class="mi">315</span><span class="p">,</span><span class="mi">332</span><span class="p">],[</span><span class="mi">367</span><span class="p">,</span><span class="mi">413</span><span class="p">],[</span><span class="mi">438</span><span class="p">,</span><span class="mi">467</span><span class="p">],[</span><span class="mi">440</span><span class="p">,</span><span class="mi">410</span><span class="p">],[</span><span class="mi">365</span><span class="p">,</span><span class="mi">474</span><span class="p">],[</span><span class="mi">36</span><span class="p">,</span><span class="mi">429</span><span class="p">],[</span><span class="mi">36</span><span class="p">,</span><span class="mi">499</span><span class="p">],[</span><span class="mi">27</span><span class="p">,</span><span class="mi">381</span><span class="p">]])</span>

    <span class="c1"># Read destination image.
</span>    <span class="n">im_dst</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">dst_path</span><span class="p">)</span>
    <span class="c1"># Four corners of the book in destination image.
</span>    <span class="n">pts_dst</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">5</span><span class="p">,</span><span class="mi">129</span><span class="p">],[</span><span class="mi">115</span><span class="p">,</span><span class="mi">107</span><span class="p">],[</span><span class="mi">261</span><span class="p">,</span><span class="mi">110</span><span class="p">],[</span><span class="mi">436</span><span class="p">,</span><span class="mi">106</span><span class="p">],[</span><span class="mi">327</span><span class="p">,</span><span class="mi">285</span><span class="p">],[</span><span class="mi">382</span><span class="p">,</span><span class="mi">418</span><span class="p">],[</span><span class="mi">465</span><span class="p">,</span><span class="mi">516</span><span class="p">],[</span><span class="mi">465</span><span class="p">,</span><span class="mi">418</span><span class="p">],[</span><span class="mi">382</span><span class="p">,</span><span class="mi">515</span><span class="p">],[</span><span class="mi">19</span><span class="p">,</span><span class="mi">438</span><span class="p">],[</span><span class="mi">12</span><span class="p">,</span><span class="mi">551</span><span class="p">],[</span><span class="mi">10</span><span class="p">,</span><span class="mi">352</span><span class="p">]])</span>

    <span class="c1"># Calculate Homography
</span>    <span class="n">h</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">findHomography</span><span class="p">(</span><span class="n">pts_dst</span><span class="p">,</span> <span class="n">pts_src</span><span class="p">)</span>
    <span class="c1">#h, status = cv2.getPerspectiveTransform(pts_dst, pts_src)
</span>
    <span class="n">test_points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">328</span><span class="p">,</span><span class="mi">218</span><span class="p">],[</span><span class="mi">423</span><span class="p">,</span><span class="mi">333</span><span class="p">]])</span>
    <span class="n">test_points</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">(</span><span class="n">test_points</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Warp destination image to source image based on homography
</span>    <span class="n">im_out</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">warpPerspective</span><span class="p">(</span><span class="n">im_dst</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="n">im_src</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">im_src</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">transformed_points</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">perspectiveTransform</span><span class="p">(</span><span class="n">test_points</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"transfored points are </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">transformed_points</span><span class="p">)</span>

    <span class="c1"># Display images
</span>    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Source Image"</span><span class="p">,</span> <span class="n">im_src</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Destination Image"</span><span class="p">,</span> <span class="n">im_dst</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">"Warped Source Image"</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>


    <span class="c1">#cv2.imwrite(out_path + "warped_img_{}_pts.png".format(pts_src.shape[0]), im_out)
</span>    <span class="n">np</span><span class="p">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_path</span> <span class="o">+</span> <span class="s">"trans_matrix_{}_pts.txt"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pts_src</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">h</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">'%s'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"h : "</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>

    <span class="n">cv2</span><span class="p">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span> <span class="p">:</span>

    <span class="n">dst_path</span> <span class="o">=</span> <span class="s">"/home/sush/TS/depth_testing/validation/camtop_raw/0.png"</span>
    <span class="n">src_path</span> <span class="o">=</span> <span class="s">"/home/sush/TS/depth_testing/validation/depth_raw/0.png"</span>
    <span class="n">compute_transformation</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span><span class="n">dst_path</span><span class="p">)</span>
</code></pre></div></div><h3 id="points-to-note-on-perspective-transform-opencv-functions"> <a href="#points-to-note-on-perspective-transform-opencv-functions" class="anchor-heading" aria-labelledby="points-to-note-on-perspective-transform-opencv-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Points to Note on perspective transform opencv functions:</h3><ol><li><p>cv2.warpPerspective is used to transform the whole image and takes ~50ms on a Xavier NX (as of 2022). Therefore it must be used sparingly to prevent the pipeline from slowing down and the ros_node from publishing at the low frequency</p><li><p>cv2.perspectiveTransform works only on points in the image (image vectors), and is therefore much faster</p></ol><p><em>if the requirement is to map object detection boxes in one image onto another, then simply take the box corners and use perspectiveTransform to save computation time</em></p><h1 id="buiding-and-using-opencv-with-cuda"> <a href="#buiding-and-using-opencv-with-cuda" class="anchor-heading" aria-labelledby="buiding-and-using-opencv-with-cuda"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Buiding and Using opencv with CUDA</h1><h2 id="the-process-for-building-opencv-with-cuda"> <a href="#the-process-for-building-opencv-with-cuda" class="anchor-heading" aria-labelledby="the-process-for-building-opencv-with-cuda"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The process for building opencv with CUDA</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To build opencv from source do the following:
________________________________________________________
Install Dependencies

sudo apt-get update
sudo apt-get upgrade
sudo apt-get install build-essential cmake unzip pkg-config
sudo apt-get install libjpeg-dev libpng-dev libtiff-dev
sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev
sudo apt-get install libv4l-dev libxvidcore-dev libx264-dev
sudo apt-get install libgtk-3-dev
sudo apt-get install libblas-dev liblapack-dev gfortran
sudo apt-get install python3-dev
_______________________________________________________________________________________________________________________________

Pull the repos of Opencv and Opencv_contrib
 cd ~
 wget -O opencv-4.5.1.zip https://github.com/opencv/opencv/archive/4.5.1.zip
 unzip -q opencv-4.5.1.zip
 mv opencv-4.5.1 opencv
 rm -f opencv-4.5.1.zip

 wget -O opencv_contrib-4.5.1.zip https://github.com/opencv/opencv_contrib/archive/4.5.1.zip
 unzip -q opencv_contrib-4.5.1.zip
 mv opencv_contrib-4.5.1 opencv_contrib
 rm -f opencv_contrib-4.5.1.zip
_______________________________________________________________________________________________________________________________

If you want to work within a venv, create one and do a pip3 install numpy and pip install numpy
Else, just do the same in global
_______________________________________________________________________________________________________________________________

Go into the folder

 cd ~/opencv
 mkdir build
 cd build
 
Then, run the below cmake command with all arguments (directly copy paste from here)

cmake \
      -D CMAKE_BUILD_TYPE=RELEASE \
      -D CMAKE_INSTALL_PREFIX=/usr/local \
      -D INSTALL_PYTHON_EXAMPLES=OFF \
      -D INSTALL_C_EXAMPLES=OFF \
      -D OPENCV_ENABLE_NONFREE=ON \
      -D OPENCV_EXTRA_MODULES_PATH=~/opencv_contrib/modules \
      -D BUILD_EXAMPLES=ON \
      -D WITH_CUDA=ON \
      -D WITH_CUDNN=ON \
      -D OPENCV_DNN_CUDA=ON \
      -D WITH_CUBLAS=ON \
      -D CUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda-10.2 \
      -D WITH_OPENGL=ON \
      -D INSTALL_C_EXAMPLES=OFF \
      ..
______________________________________________________________________________________________________________________________

Follow this up with:

 make
 sudo make install
 sudo ldconfig
 
Now we need to link this new opencv to python:

sudo /bin/bash -c 'echo "/usr/local/lib" &gt;&gt; /etc/ld.so.conf.d/opencv.conf'
________________________________________________________________________________________________________________________________

References:
https://gist.github.com/raulqf/f42c718a658cddc16f9df07ecc627be7
https://learnopencv.com/opencv-dnn-with-gpu-support/
https://docs.opencv.org/4.x/d6/d15/tutorial_building_tegra_cuda.html

Use the below link to understand how we can use cuda for generic opencv functions
https://medium.com/dropout-analytics/opencv-cuda-for-videos-f3dcf346e398
</code></pre></div></div><h2 id="example-of-cv2cuda"> <a href="#example-of-cv2cuda" class="anchor-heading" aria-labelledby="example-of-cv2cuda"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example of cv2.cuda</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># create an instance of the GpuMat object
</span><span class="n">gpu_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cuda_GpuMat</span><span class="p">()</span>
<span class="c1"># upload the image to the GPU via the api
</span><span class="n">gpu_frame</span><span class="p">.</span><span class="n">upload</span><span class="p">(</span><span class="n">image_raw</span><span class="p">)</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">image_raw</span><span class="p">.</span><span class="n">shape</span>
<span class="c1"># notice how we are adding just cuda to make it work on GPU
</span><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">gpu_frame</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
<span class="c1"># Calculate width and height and paddings
</span><span class="n">r_w</span> <span class="o">=</span> <span class="n">INPUT_W</span> <span class="o">/</span> <span class="n">w</span>
<span class="n">r_h</span> <span class="o">=</span> <span class="n">INPUT_H</span> <span class="o">/</span> <span class="n">h</span>
<span class="k">if</span> <span class="n">r_h</span> <span class="o">&gt;</span> <span class="n">r_w</span><span class="p">:</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">INPUT_W</span>
    <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_w</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">tx1</span> <span class="o">=</span> <span class="n">tx2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ty1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">INPUT_H</span> <span class="o">-</span> <span class="n">th</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ty2</span> <span class="o">=</span> <span class="n">INPUT_H</span> <span class="o">-</span> <span class="n">th</span> <span class="o">-</span> <span class="n">ty1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r_h</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">th</span> <span class="o">=</span> <span class="n">INPUT_H</span>
    <span class="n">tx1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">INPUT_W</span> <span class="o">-</span> <span class="n">tw</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">tx2</span> <span class="o">=</span> <span class="n">INPUT_W</span> <span class="o">-</span> <span class="n">tw</span> <span class="o">-</span> <span class="n">tx1</span>
    <span class="n">ty1</span> <span class="o">=</span> <span class="n">ty2</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># Resize the image with long side while maintaining ratio
</span><span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">tw</span><span class="p">,</span><span class="n">th</span><span class="p">))</span>
<span class="c1"># Pad the short side with (128,128,128)
</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">download</span><span class="p">()</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">copyMakeBorder</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">ty1</span><span class="p">,</span> <span class="n">ty2</span><span class="p">,</span> <span class="n">tx1</span><span class="p">,</span> <span class="n">tx2</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div><hr><footer><p class="text-small text-grey-dk-100 mb-0"></p><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div>
